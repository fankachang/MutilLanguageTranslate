# Feature Specification: 多國語言翻譯系統

**Feature Branch**: `001-multilang-translation`  
**Created**: 2026-01-11  
**Status**: Draft  
**Input**: 開發一個內網多國語言翻譯系統，供員工快速進行文字翻譯，支援多種語言互譯。系統部署於內網環境，員工透過瀏覽器訪問使用，無需帳號登入。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 基本文字翻譯 (Priority: P1)

員工需要將一段文字從一種語言翻譯成另一種語言。員工在翻譯頁面輸入原文、選擇目標語言後點擊翻譯按鈕，系統顯示翻譯結果，員工可將結果複製到剪貼簿使用。

**Why this priority**: 這是翻譯系統最核心的功能價值，沒有此功能則系統無任何使用意義。

**Independent Test**: 可透過輸入「你好世界」並選擇英文作為目標語言來測試，期望獲得英文翻譯結果並可複製。

**Acceptance Scenarios**:

1. **Given** 員工在翻譯頁面且未輸入任何文字, **When** 查看翻譯按鈕狀態, **Then** 翻譯按鈕為禁用狀態
2. **Given** 員工輸入「我需要將這份報告翻譯成英文」並選擇英文為目標語言, **When** 點擊翻譯按鈕, **Then** 顯示對應的英文翻譯結果
3. **Given** 翻譯結果已顯示, **When** 點擊「複製結果」按鈕, **Then** 譯文內容被複製到系統剪貼簿

---

### User Story 2 - 多語言選擇與自動偵測 (Priority: P1)

員工可以選擇 8 種語言進行任意雙向翻譯，或使用「自動偵測」讓系統識別來源語言。員工也可快速交換來源與目標語言。

**Why this priority**: 多語言支援是系統核心需求，員工需要處理多種語言組合的翻譯工作。

**Independent Test**: 可透過輸入日文文字並選擇「自動偵測」為來源語言、韓文為目標語言來測試，期望系統正確識別並完成翻譯。

**Acceptance Scenarios**:

1. **Given** 員工在翻譯頁面, **When** 點擊來源語言下拉選單, **Then** 顯示「自動偵測」及 8 種支援語言（繁體中文、簡體中文、英文、日文、韓文、法文、德文、西班牙文）
2. **Given** 員工輸入日文文字並選擇「自動偵測」為來源語言, **When** 執行翻譯, **Then** 系統正確識別為日文並顯示「偵測到的語言：日文」
3. **Given** 目前設定為中文→英文, **When** 點擊「語言交換」按鈕, **Then** 來源變為英文、目標變為中文，且原譯文自動填入原文欄位

---

### User Story 3 - 錯誤處理與使用者提示 (Priority: P1)

系統在發生錯誤時（輸入錯誤、服務異常、網路問題等）提供清晰的中文錯誤訊息，協助員工了解問題並採取對應措施。

**Why this priority**: 良好的錯誤處理確保系統可用性與使用者體驗，避免員工因不明錯誤而無法完成工作。

**Independent Test**: 可透過輸入空白文字、超過字數限制的文字，或模擬網路中斷來測試各種錯誤提示是否正確顯示。

**Acceptance Scenarios**:

1. **Given** 員工未輸入任何文字, **When** 嘗試執行翻譯, **Then** 顯示「請輸入要翻譯的文字」提示訊息
2. **Given** 員工輸入超過 10,000 字元的文字, **When** 嘗試執行翻譯, **Then** 顯示「文字長度超過 10,000 字元，請縮短後再試」提示訊息
3. **Given** 員工選擇來源語言與目標語言相同, **When** 查看翻譯按鈕, **Then** 翻譯按鈕禁用並顯示「來源語言與目標語言不可相同」提示
4. **Given** 翻譯服務暫時無回應, **When** 員工執行翻譯, **Then** 顯示「翻譯服務暫時無法使用，請稍後再試」提示訊息

---

### User Story 4 - 使用者設定調整 (Priority: P2)

員工可調整翻譯品質（快速/標準/高品質）、介面主題（亮色/暗色）、字體大小（小/中/大），設定於會話期間保留。

**Why this priority**: 個人化設定提升使用體驗，但非核心翻譯功能，故為次要優先。

**Independent Test**: 可透過調整主題為暗色、字體為大，重新整理頁面後檢查設定是否保留（同一標籤頁）。

**Acceptance Scenarios**:

1. **Given** 員工在設定頁面, **When** 選擇「高品質」翻譯模式並儲存, **Then** 後續翻譯使用高品質模式處理
2. **Given** 員工已調整主題為暗色, **When** 重新整理頁面（不關閉標籤頁）, **Then** 設定保持為暗色主題
3. **Given** 員工已調整主題為暗色, **When** 關閉標籤頁後重新開啟, **Then** 設定恢復為預設亮色主題

---

### User Story 5 - 翻譯歷史記錄 (Priority: P2)

系統記錄當前會話的最近 20 筆翻譯記錄，員工可點擊歷史記錄快速重現先前的翻譯。

**Why this priority**: 歷史記錄便於員工回顧與重複使用翻譯結果，但非核心翻譯功能。

**Independent Test**: 可透過執行多次翻譯後，檢查歷史記錄列表是否正確顯示，並點擊記錄驗證是否可重現。

**Acceptance Scenarios**:

1. **Given** 員工已完成一筆翻譯, **When** 查看翻譯歷史, **Then** 顯示該筆記錄（含原文預覽、譯文預覽、語言資訊、時間戳）
2. **Given** 員工已有 20 筆歷史記錄, **When** 完成第 21 筆翻譯, **Then** 最舊的一筆記錄被移除，保持 20 筆上限
3. **Given** 員工點擊歷史記錄中的某筆記錄, **When** 執行操作, **Then** 原文與譯文自動填入對應欄位，來源與目標語言自動設定

---

### User Story 6 - 系統狀態監控 (Priority: P2)

管理人員可查看系統狀態監控頁面，了解系統運行狀態、資源使用、翻譯統計等資訊。

**Why this priority**: 監控功能協助維運人員掌握系統健康狀況，但為管理功能非使用者核心需求。

**Independent Test**: 可透過訪問系統狀態頁面，檢查是否顯示系統狀態、並發請求數、記憶體、CPU 使用率等資訊。

**Acceptance Scenarios**:

1. **Given** 管理人員訪問系統狀態頁面, **When** 頁面載入完成, **Then** 顯示系統執行狀態（運行中/停止）與翻譯模型狀態（已載入/未載入）
2. **Given** 系統正在處理翻譯請求, **When** 查看系統狀態頁面, **Then** 顯示當前並發請求數（如 12/100）
3. **Given** 管理人員查看系統狀態頁面, **When** 檢視統計區塊, **Then** 顯示近 24 小時的總翻譯請求數、成功率、平均處理時間

---

### Edge Cases

- 當輸入文字包含表情符號、特殊標點符號時，系統應正確處理不影響翻譯品質
- 當輸入包含多餘空白或換行時，系統應保留段落格式並正確處理
- 當 TAIDE-LX-7B 模型進行自動語言偵測的信心分數低於 0.5 時，系統應回退使用繁體中文作為預設來源語言
- 當並發請求超過 100 時，新請求應進入等待佇列並顯示「等待中」狀態
- 當總請求數超過 200 時，系統應拒絕新請求並返回適當錯誤訊息
- 當 GPU 不可用時，系統應自動降級切換至 CPU 模式繼續運作

## Clarifications

### Session 2026-01-11

- Q: 翻譯逾時的預設閾值應為多少？ → A: 120 秒，且可透過設定檔動態變更
- Q: 系統狀態頁面的存取權限如何控制？ → A: 僅限白名單 IP 存取，可透過設定檔配置 IP 範圍或清單
- Q: 翻譯品質模式（快速/標準/高品質）的具體差異機制為何？ → A: 透過生成參數調整（temperature、beam search 等）控制品質與速度
- Q: 內網 IP 範圍如何配置？ → A: 透過設定檔配置 CIDR 格式的 IP 範圍
- Q: 翻譯模型的選擇與配置策略為何？ → A: 使用現有的 TAIDE-LX-7B 模型，架構設計保留後續新增其他模型的彈性
- Q: 資料模型中的 Translation Request 與 Translation Response 實體需要持久化儲存嗎？ → A: 僅保留在記憶體或快取中，不持久化
- Q: FR-036 要求顯示近 24 小時的翻譯統計，但翻譯請求不持久化，如何實現統計資料儲存？ → A: 使用記憶體內時間序列結構（如滑動視窗）保存統計聚合資料
- Q: 自動語言偵測的信心分數來源與實現機制為何？ → A: 由 TAIDE-LX-7B 模型同時執行語言偵測與翻譯
- Q: FR-043 要求優雅停止,如果進行中的翻譯請求在停止信號後仍未完成,最長應等待多久? → A: 120 秒
- Q: FR-045 健康檢查端點應該驗證哪些條件? → A: 驗證 API 服務可回應 + 翻譯模型已載入
- Q: 日誌輸出的實現方式為何(檔案系統、串流、或集中式系統)? → A: 直接寫入檔案系統(logs/ 目錄),由應用程式自行管理日誌輪替
- Q: 系統架構模式為何(前後端分離、單體、或微服務)? → A: 單體應用程式(後端 API + 靜態前端打包於同一服務)
- Q: 技術棧選擇為何? → A: Python 3.11+ / Django 4.2+ (ASGI) 單體應用程式，前端使用 Django Templates + HTMX/Alpine.js
- Q: 記憶體快取與統計資料的實現機制為何? → A: 使用 Django Cache Framework 搭配 threading.Lock 實現滑動視窗

## Requirements *(mandatory)*

### Functional Requirements

#### 基本翻譯功能
- **FR-001**: 系統必須允許使用者輸入原文文字（1 至 10,000 字元）
- **FR-002**: 系統必須提供目標語言選擇功能
- **FR-003**: 系統必須在使用者點擊翻譯按鈕後顯示翻譯結果
- **FR-004**: 系統必須提供「複製結果」功能，將譯文複製到系統剪貼簿
- **FR-005**: 系統必須即時顯示輸入文字的字數統計（如「12 / 10,000 字元」）
- **FR-006**: 系統必須保留原文的段落換行格式於翻譯結果中
- **FR-007**: 系統必須正確處理表情符號、特殊標點符號，不影響翻譯品質

#### 多語言支援
- **FR-008**: 系統必須支援 8 種語言：繁體中文(zh-TW)、簡體中文(zh-CN)、英文(en)、日文(ja)、韓文(ko)、法文(fr)、德文(de)、西班牙文(es)
- **FR-009**: 系統必須支援任意兩種語言間的雙向翻譯
- **FR-010**: 系統必須提供「自動偵測」來源語言選項，由 TAIDE-LX-7B 模型執行語言識別
- **FR-011**: 系統必須在使用自動偵測時顯示偵測到的語言（如「偵測到的語言：英文」）。當信心分數低於 0.5 時，系統應回退使用繁體中文作為預設
- **FR-012**: 系統必須提供快速交換來源語言與目標語言的功能
- **FR-013**: 系統預設目標語言必須為繁體中文

#### 使用者設定
- **FR-014**: 系統必須允許使用者調整翻譯品質（快速/標準/高品質，預設為標準），透過生成參數（temperature、beam search 等）控制品質與速度平衡
- **FR-015**: 系統必須允許使用者切換介面主題（亮色/暗色，預設為亮色）
- **FR-016**: 系統必須允許使用者調整字體大小（小/中/大，預設為中）
- **FR-017**: 系統必須將使用者設定儲存於瀏覽器 sessionStorage，會話期間有效
- **FR-018**: 系統必須在標籤頁關閉後自動清除使用者設定（恢復預設值）

#### 翻譯歷史
- **FR-019**: 系統必須記錄當前會話的翻譯歷史，最多 20 筆
- **FR-020**: 系統必須顯示歷史記錄的原文預覽（前 50 字元）、譯文預覽（前 50 字元）、語言資訊、時間戳
- **FR-021**: 系統必須允許使用者點擊歷史記錄快速重現翻譯
- **FR-022**: 系統必須在會話結束（標籤頁關閉）後自動清除歷史記錄

#### 錯誤處理
- **FR-023**: 系統必須在輸入為空時禁用翻譯按鈕並提示「請輸入要翻譯的文字」
- **FR-024**: 系統必須在超過 10,000 字元時提示「文字長度超過 10,000 字元，請縮短後再試」
- **FR-025**: 系統必須在來源與目標語言相同時禁用翻譯按鈕並提示「來源語言與目標語言不可相同」
- **FR-026**: 系統必須在翻譯服務無回應時顯示「翻譯服務暫時無法使用，請稍後再試」
- **FR-027**: 系統必須在網路連線失敗時顯示「網路連線失敗，請檢查網路狀態」
- **FR-028**: 系統必須在翻譯逾時時顯示「翻譯逾時，請嘗試縮短文字長度或稍後再試」（預設逾時閾值：120 秒，可透過設定檔動態調整）
- **FR-029**: 所有錯誤訊息必須以繁體中文顯示，並提供明確的解決建議

#### 效能與並發
- **FR-030**: 系統必須支援最多 100 個同時翻譯請求
- **FR-031**: 系統必須在超過 100 個並發時將新請求放入等待佇列（上限 100）
- **FR-032**: 系統必須在總請求數超過 200 時拒絕新請求並返回錯誤訊息
- **FR-033**: 系統必須區分並顯示「等待中」與「處理中」狀態
- **FR-034-補充**: 使用 Django Cache Framework 搭配 threading.Lock 實現執行緒安全的請求佇列與統計資料管理

#### 系統監控
- **FR-034**: 系統必須提供系統狀態監控頁面，僅限白名單 IP 存取（IP 範圍或清單可透過設定檔配置）
- **FR-035**: 系統狀態頁面必須顯示：系統執行狀態、當前並發請求數、記憶體使用量、CPU 使用率、翻譯模型狀態
- **FR-036**: 系統狀態頁面必須顯示近 24 小時的翻譯統計（請求數、成功率、平均處理時間）。統計資料使用 Django Cache Framework 實現記憶體內時間序列滑動視窗，每分鐘匯總一次

#### 安全性
- **FR-037**: 系統必須進行輸入清理以防止 XSS 攻擊
- **FR-038**: 系統必須進行輸入清理以防止 SQL 注入攻擊
- **FR-039**: 系統必須限制僅內網 IP 範圍可存取（透過設定檔配置 CIDR 格式，如 192.168.1.0/24）

#### 日誌記錄
- **FR-040**: 系統必須記錄所有程式錯誤（含錯誤類型、時間戳、堆疊追蹤）,輸出至 logs/ 目錄
- **FR-041**: 系統必須記錄翻譯請求（來源語言、目標語言、字數、處理時間、結果狀態）,輸出至 logs/ 目錄
- **FR-042**: 系統日誌保留期限預設為 30 天（可配置）,由應用程式自行管理日誌輪替

#### 維運
- **FR-043**: 系統必須支援優雅停止(完成進行中的翻譯後才停止),最長等待 120 秒,超過後強制終止
- **FR-044**: 系統必須在 GPU 不可用時自動切換到 CPU 模式
- **FR-045**: 系統必須提供健康檢查端點供監控工具使用,驗證條件包含：API 服務可回應、翻譯模型已載入

### Key Entities

- **語言 (Language)**: 代表系統支援的語言，包含語言代碼(code)、本地名稱(name)、英文名稱(name_en)、啟用狀態(enabled)
- **翻譯請求 (Translation Request)**: 代表一次翻譯操作，包含原文內容(text)、來源語言(source_lang)、目標語言(target_lang)、品質設定(quality)。僅保留在記憶體中，不持久化到資料庫
- **翻譯回應 (Translation Response)**: 代表翻譯結果，包含狀態(status)、翻譯結果(translation)、偵測語言(detected_language)、處理時間(processing_time)、執行模式(execution_mode)。僅保留在記憶體中，不持久化到資料庫
- **使用者設定 (User Settings)**: 代表使用者偏好，包含品質(quality)、主題(theme)、字體大小(fontSize)、常用語言(sourceLang/targetLang)。儲存於瀏覽器 sessionStorage
- **翻譯歷史 (Translation History)**: 代表歷史記錄，包含唯一識別碼(id)、原文預覽(original_text)、譯文預覽(translated_text)、語言資訊、時間戳(timestamp)。儲存於瀏覽器 sessionStorage，會話結束後清除

## Assumptions

- 系統部署於內網環境,所有使用者為公司內部員工
- 無需使用者帳號驗證,直接開放使用
- 翻譯模型使用現有的 TAIDE-LX-7B（路徑：models/models--taide--TAIDE-LX-7B）,架構設計保留後續擴充其他模型的彈性
- 系統採用 Python 3.11+ / Django 4.2+ (ASGI) 單體架構，整合後端 API 與前端模板
- 前端使用 Django Templates 搭配 HTMX + Alpine.js 實現互動介面，避免重型 SPA 框架
- 模型推論直接整合於 Django 應用程式內，透過 transformers 庫載入 TAIDE-LX-7B
- 單一 Python 程序處理 HTTP 請求與模型推論，簡化部署與維護
- 內網環境具備穩定的網路連線
- 伺服器具備足夠的硬體資源（建議 8 核心 CPU、16GB RAM,GPU 優先用於模型推論）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者可在 3 個步驟內完成一次翻譯操作（輸入→選擇語言→點擊翻譯）
- **SC-002**: 系統支援 100 個同時使用者進行翻譯而不發生服務中斷
- **SC-003**: 90% 以上的翻譯請求成功完成（24 小時統計）
- **SC-004**: 使用者可在 2 秒內完成複製翻譯結果至剪貼簿的操作
- **SC-005**: 系統在 GPU 不可用時自動降級，持續提供翻譯服務
- **SC-006**: 錯誤訊息清晰明確，使用者可根據提示自行排除 80% 以上的常見問題
- **SC-007**: 語言交換功能可在 1 秒內完成來源與目標語言的切換
- **SC-008**: 翻譯歷史記錄讓使用者可在 5 秒內重現先前的翻譯操作
