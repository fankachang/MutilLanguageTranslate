{% extends 'translator/base.html' %}

{% block title %}æ­·å²è¨˜éŒ„ - å¤šåœ‹èªè¨€ç¿»è­¯ç³»çµ±{% endblock %}

{% block content %}
<div x-data="historyApp()">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">ç¿»è­¯æ­·å²è¨˜éŒ„</h2>
            <button 
                type="button" 
                class="btn btn-secondary btn-sm"
                @click="clearHistory"
                x-show="historyItems.length > 0"
            >
                ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨
            </button>
        </div>
        
        <!-- ç„¡è¨˜éŒ„æç¤º -->
        <div x-show="historyItems.length === 0" class="empty-state">
            <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                <div style="font-size: 3rem; margin-bottom: 16px;">ğŸ“</div>
                <p>å°šç„¡ç¿»è­¯è¨˜éŒ„</p>
                <p style="font-size: 0.875rem;">æ‚¨çš„ç¿»è­¯è¨˜éŒ„å°‡åœ¨æ­¤è™•é¡¯ç¤ºï¼ˆå„²å­˜æ–¼ç€è¦½å™¨ session ä¸­ï¼‰</p>
                <a href="{% url 'index' %}" class="btn btn-primary" style="margin-top: 16px;">
                    é–‹å§‹ç¿»è­¯
                </a>
            </div>
        </div>
        
        <!-- æ­·å²è¨˜éŒ„åˆ—è¡¨ -->
        <div x-show="historyItems.length > 0" class="history-list">
            <template x-for="item in historyItems" :key="item.id">
                <div class="history-item card" style="margin-bottom: 12px;">
                    <div class="history-item-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div class="history-meta">
                            <span class="language-badge" x-text="getLanguageName(item.sourceLang)"></span>
                            <span style="margin: 0 8px;">â†’</span>
                            <span class="language-badge" x-text="getLanguageName(item.targetLang)"></span>
                            <span 
                                x-show="item.detectedLang" 
                                class="detected-badge"
                                style="margin-left: 8px; font-size: 0.75rem; color: var(--text-secondary);"
                            >
                                (åµæ¸¬: <span x-text="getLanguageName(item.detectedLang)"></span>)
                            </span>
                        </div>
                        <div class="history-time" style="font-size: 0.75rem; color: var(--text-secondary);">
                            <span x-text="formatTime(item.timestamp)"></span>
                        </div>
                    </div>
                    
                    <div class="history-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="original-text">
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">åŸæ–‡</div>
                            <div 
                                style="background-color: var(--bg-secondary); padding: 12px; border-radius: 6px; max-height: 100px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;"
                                x-text="item.fullOriginalText"
                            ></div>
                        </div>
                        <div class="translated-text">
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">è­¯æ–‡</div>
                            <div 
                                style="background-color: var(--bg-secondary); padding: 12px; border-radius: 6px; max-height: 100px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;"
                                x-text="item.fullTranslatedText"
                            ></div>
                        </div>
                    </div>
                    
                    <div class="history-actions" style="margin-top: 12px; display: flex; gap: 8px;">
                        <button 
                            type="button" 
                            class="btn btn-secondary btn-sm"
                            @click="copyText(item.fullTranslatedText)"
                        >
                            ğŸ“‹ è¤‡è£½è­¯æ–‡
                        </button>
                        <button 
                            type="button" 
                            class="btn btn-secondary btn-sm"
                            @click="reuseTranslation(item)"
                        >
                            ğŸ”„ å†æ¬¡ç¿»è­¯
                        </button>
                        <button 
                            type="button" 
                            class="btn btn-secondary btn-sm"
                            @click="deleteItem(item.id)"
                            style="margin-left: auto;"
                        >
                            âœ•
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function historyApp() {
    return {
        historyItems: [],
        
        languageNames: {
            'zh-TW': 'ç¹é«”ä¸­æ–‡',
            'zh-CN': 'ç°¡é«”ä¸­æ–‡',
            'en': 'è‹±æ–‡',
            'ja': 'æ—¥æ–‡',
            'ko': 'éŸ“æ–‡',
            'fr': 'æ³•æ–‡',
            'de': 'å¾·æ–‡',
            'es': 'è¥¿ç­ç‰™æ–‡',
            'auto': 'è‡ªå‹•åµæ¸¬',
        },
        
        init() {
            this.loadHistory();
        },
        
        loadHistory() {
            try {
                this.historyItems = JSON.parse(sessionStorage.getItem('translationHistory') || '[]');
            } catch (e) {
                console.error('è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—:', e);
                this.historyItems = [];
            }
        },
        
        getLanguageName(code) {
            return this.languageNames[code] || code;
        },
        
        formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-TW', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        
        async copyText(text) {
            try {
                await navigator.clipboard.writeText(text);
                alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            } catch (e) {
                console.error('è¤‡è£½å¤±æ•—:', e);
            }
        },
        
        reuseTranslation(item) {
            // å„²å­˜åˆ° session ä¸¦è·³è½‰
            sessionStorage.setItem('reuseTranslation', JSON.stringify(item));
            window.location.href = '{% url "index" %}';
        },
        
        deleteItem(id) {
            this.historyItems = this.historyItems.filter(item => item.id !== id);
            sessionStorage.setItem('translationHistory', JSON.stringify(this.historyItems));
        },
        
        clearHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„å—ï¼Ÿ')) {
                this.historyItems = [];
                sessionStorage.removeItem('translationHistory');
            }
        }
    };
}
</script>
{% endblock %}
