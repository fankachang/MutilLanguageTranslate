openapi: 3.0.3
info:
  title: 多國語言翻譯系統 API（模型切換/公開狀態）
  version: 1.0.0
  description: |
    本合約涵蓋本次功能擴充：
    - 模型清單掃描與切換（前端可選帶 model_id）
    - 公開系統狀態與統計（匿名可存取）

servers:
  - url: http://localhost:8000

paths:
  /api/v1/models/:
    get:
      summary: 取得可用模型清單
      description: |
        回傳由 `models/` 目錄掃描得到的可用模型清單。
        可用模型的最低條件：`models/<model_id>/config.json` 存在且可讀取。
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelsListResponse'

  /api/v1/models/selection/:
    put:
      summary: 設定本會話選定模型
      description: |
        設定使用者的選定模型（每瀏覽器會話偏好）。
        伺服器可選擇寫入 Django session；前端也可單純保存於 sessionStorage。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ModelSelectionRequest'
      responses:
        '200':
          description: 已設定（不代表模型已完成載入）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelSelectionResponse'
        '400':
          description: 參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/models/switch/:
    post:
      summary: 切換 active model（含回退）
      description: |
        觸發伺服器端切換 active model。
        需支援：切換期間顯示載入中；失敗需回退到先前可用模型。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ModelSwitchRequest'
      responses:
        '200':
          description: 切換完成
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelSwitchResponse'
        '409':
          description: 忙碌或切換政策拒絕
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 切換失敗（已回退或無可回退）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/status/:
    get:
      summary: 公開系統狀態（匿名可用）
      description: |
        供狀態頁讀取的只讀端點；不得要求 admin 權限或 IP 白名單。
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicStatusResponse'

  /api/v1/statistics/:
    get:
      summary: 公開翻譯統計（匿名可用）
      description: |
        供狀態頁讀取的只讀端點；不得要求 admin 權限或 IP 白名單。
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicStatisticsResponse'

  /api/v1/model/load-progress/:
    get:
      summary: 公開模型載入進度（匿名可用）
      description: |
        僅提供讀取進度；觸發載入（POST）仍應保留在受保護的 admin 端點。
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelLoadProgressResponse'

  /api/v1/translate/:
    post:
      summary: 執行翻譯（可選指定 model_id）
      description: |
        既有翻譯端點，為保持相容性，新增可選欄位 `model_id`。
        未提供時應維持既有預設行為。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TranslateRequest'
      responses:
        '200':
          description: 已完成
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TranslateCompletedResponse'
        '202':
          description: 排隊中
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TranslateQueuedResponse'
        '400':
          description: 參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 內部錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
              example: INTERNAL_ERROR
            message:
              type: string
              example: 系統發生未預期錯誤，請稍後再試

    ModelEntry:
      type: object
      required: [model_id, display_name, has_config]
      properties:
        model_id:
          type: string
          description: 模型目錄名稱
          example: Translategemma-4b-it
        display_name:
          type: string
          description: 顯示名稱（必須與 model_id 一致）
          example: Translategemma-4b-it
        has_config:
          type: boolean
          example: true
        last_error_message:
          type: string
          nullable: true
          example: 模型載入失敗：缺少 tokenizer.json

    ModelsListResponse:
      type: object
      required: [models]
      properties:
        models:
          type: array
          items:
            $ref: '#/components/schemas/ModelEntry'
        active_model_id:
          type: string
          nullable: true
          example: Translategemma-4b-it
        selected_model_id:
          type: string
          nullable: true
          example: Translategemma-12b-it

    ModelSelectionRequest:
      type: object
      required: [model_id]
      properties:
        model_id:
          type: string
          example: Translategemma-12b-it

    ModelSelectionResponse:
      type: object
      required: [selected_model_id, active_model_id, requires_switch]
      properties:
        selected_model_id:
          type: string
          nullable: true
        active_model_id:
          type: string
          nullable: true
        requires_switch:
          type: boolean
          description: selected_model_id 是否與 active_model_id 不同

    ModelSwitchRequest:
      type: object
      required: [model_id]
      properties:
        model_id:
          type: string
          example: Translategemma-4b-it
        force:
          type: boolean
          default: false
          description: 是否忽略忙碌/政策限制（若有）

    ModelSwitchResponse:
      type: object
      required: [status, active_model_id]
      properties:
        status:
          type: string
          enum: [switched]
          example: switched
        active_model_id:
          type: string
          example: Translategemma-4b-it
        previous_model_id:
          type: string
          nullable: true
          example: Translategemma-12b-it

    PublicStatusResponse:
      type: object
      required: [status, timestamp]
      properties:
        status:
          type: string
          example: ok
        timestamp:
          type: string
          example: 2026-01-21T00:00:00Z
        system:
          type: object
          additionalProperties: true
        resources:
          type: object
          additionalProperties: true
        uptime:
          type: object
          additionalProperties: true
        model:
          type: object
          additionalProperties: true
        queue:
          type: object
          additionalProperties: true

    PublicStatisticsResponse:
      type: object
      required: [status, statistics]
      properties:
        status:
          type: string
          example: ok
        statistics:
          type: object
          additionalProperties: true

    ModelLoadProgressResponse:
      type: object
      required: [status, progress, model_status, loaded]
      properties:
        status:
          type: string
          example: ok
        progress:
          type: number
          format: float
          example: 42.5
        model_status:
          type: string
          example: loading
        loaded:
          type: boolean
          example: false
        error_message:
          type: string
          nullable: true

    TranslateRequest:
      type: object
      required: [text, target_language]
      properties:
        text:
          type: string
        source_language:
          type: string
          default: auto
        target_language:
          type: string
          example: en
        quality:
          type: string
          default: standard
          description: fast|standard|high
        model_id:
          type: string
          nullable: true
          description: 可選指定模型（目錄名稱）
          example: Translategemma-4b-it

    TranslateCompletedResponse:
      type: object
      required: [request_id, status, translated_text]
      properties:
        request_id:
          type: string
          format: uuid
        status:
          type: string
          example: completed
        translated_text:
          type: string
        processing_time_ms:
          type: number
          format: float
        execution_mode:
          type: string
        detected_language:
          type: string
          nullable: true
        confidence_score:
          type: number
          format: float
          nullable: true

    TranslateQueuedResponse:
      type: object
      required: [request_id, status, queue_position, estimated_wait_seconds]
      properties:
        request_id:
          type: string
          format: uuid
        status:
          type: string
          example: pending
        queue_position:
          type: integer
          example: 3
        estimated_wait_seconds:
          type: integer
          example: 9
