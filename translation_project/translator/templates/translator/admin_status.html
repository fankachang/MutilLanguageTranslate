{% extends 'translator/base.html' %}
{% load static %}

{% block title %}ç³»çµ±ç‹€æ…‹ - å¤šåœ‹èªè¨€ç¿»è­¯ç³»çµ±{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'translator/css/admin.css' %}">
{% endblock %}

{% block content %}
<div x-data="adminStatusApp()" x-init="init()">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="admin-header">
        <h1 class="admin-title">ğŸ“Š ç³»çµ±ç‹€æ…‹ç›£æ§</h1>
        <div class="admin-actions">
            <button type="button" class="btn btn-secondary btn-sm" @click="refresh" :disabled="loading">
                <span x-show="!loading">ğŸ”„ é‡æ–°æ•´ç†</span>
                <span x-show="loading">
                    <span class="spinner" style="width: 14px; height: 14px;"></span>
                    è¼‰å…¥ä¸­...
                </span>
            </button>
            <label style="display: flex; align-items: center; gap: 8px; margin-left: 16px;">
                <input type="checkbox" x-model="autoRefresh" @change="toggleAutoRefresh">
                è‡ªå‹•æ›´æ–°ï¼ˆæ¯ 30 ç§’ï¼‰
            </label>
        </div>
    </div>

    <!-- éŒ¯èª¤è¨Šæ¯ -->
    <div x-show="error" class="error-container error-danger" style="margin-bottom: 20px;">
        <span x-text="error"></span>
        <button type="button" class="error-close" @click="error = ''">&times;</button>
    </div>

    <!-- æ¨¡å‹è¼‰å…¥é€²åº¦ï¼ˆè‹¥æ¨¡å‹æœªè¼‰å…¥ï¼‰ -->
    <div x-show="modelLoading || (!modelLoaded && !modelLoadingComplete)" class="model-loading-container"
        style="margin-bottom: 20px; padding: 20px; background: #f5f5f5; border-radius: 8px; border-left: 4px solid #2196F3;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <div style="font-weight: bold; font-size: 16px;">ğŸ¤– æ¨¡å‹è¼‰å…¥ä¸­...</div>
            <span style="font-size: 14px; color: #666;" x-text="modelLoadProgress.toFixed(1) + '%'"></span>
        </div>
        <div class="progress-bar" style="height: 8px;">
            <div class="progress-bar-fill" :style="'width: ' + modelLoadProgress + '%'"></div>
        </div>
        <div style="margin-top: 8px; font-size: 13px; color: #666;" x-text="modelLoadMessage"></div>
        <div x-show="!modelLoading && !modelLoaded" style="margin-top: 12px;">
            <button type="button" class="btn btn-primary" @click="startModelLoading" :disabled="modelLoading">
                é–‹å§‹è¼‰å…¥æ¨¡å‹
            </button>
        </div>
    </div>

    <!-- ç‹€æ…‹ç¸½è¦½ -->
    <div class="status-overview">
        <div class="status-card" :class="getHealthClass()">
            <div class="status-icon">
                <span x-show="systemHealth === 'healthy'">âœ…</span>
                <span x-show="systemHealth === 'warning'">âš ï¸</span>
                <span x-show="systemHealth === 'error'">âŒ</span>
            </div>
            <div class="status-content">
                <div class="status-label">ç³»çµ±ç‹€æ…‹</div>
                <div class="status-value" x-text="getHealthText()"></div>
            </div>
        </div>

        <div class="status-card">
            <div class="status-icon">ğŸ–¥ï¸</div>
            <div class="status-content">
                <div class="status-label">åŸ·è¡Œæ™‚é–“</div>
                <div class="status-value" x-text="uptime"></div>
            </div>
        </div>

        <div class="status-card" :class="{ 'status-warning': modelStatus !== 'å·²è¼‰å…¥' }">
            <div class="status-icon">ğŸ¤–</div>
            <div class="status-content">
                <div class="status-label">ç¿»è­¯æ¨¡å‹</div>
                <div class="status-value" x-text="modelStatus"></div>
            </div>
        </div>

        <div class="status-card">
            <div class="status-icon">ğŸ“</div>
            <div class="status-content">
                <div class="status-label">ä½‡åˆ—ç‹€æ…‹</div>
                <div class="status-value" x-text="queueStatus"></div>
            </div>
        </div>
    </div>

    <!-- è³‡æºä½¿ç”¨ç‹€æ³ -->
    <div class="section-title">è³‡æºä½¿ç”¨ç‹€æ³</div>
    <div class="resource-grid">
        <!-- CPU -->
        <div class="resource-card">
            <div class="resource-header">
                <span class="resource-title">ğŸ’» CPU</span>
                <span class="resource-value" x-text="cpuPercent + '%'"></span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill" :class="getProgressClass(cpuPercent)"
                    :style="'width: ' + cpuPercent + '%'"></div>
            </div>
            <div class="resource-detail">
                <span>æ ¸å¿ƒæ•¸ï¼š<span x-text="cpuCores"></span></span>
                <span>ç¨‹åºä½¿ç”¨ï¼š<span x-text="processCpu + '%'"></span></span>
            </div>
        </div>

        <!-- è¨˜æ†¶é«” -->
        <div class="resource-card">
            <div class="resource-header">
                <span class="resource-title">ğŸ§  è¨˜æ†¶é«”</span>
                <span class="resource-value" x-text="memoryPercent + '%'"></span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill" :class="getProgressClass(memoryPercent)"
                    :style="'width: ' + memoryPercent + '%'"></div>
            </div>
            <div class="resource-detail">
                <span>ä½¿ç”¨ï¼š<span x-text="memoryUsed"></span> GB</span>
                <span>ç¸½è¨ˆï¼š<span x-text="memoryTotal"></span> GB</span>
            </div>
        </div>

        <!-- GPU -->
        <div class="resource-card" x-show="gpuAvailable">
            <div class="resource-header">
                <span class="resource-title">ğŸ® GPU</span>
                <span class="resource-value" x-text="gpuMemoryPercent + '%'"></span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill" :class="getProgressClass(gpuMemoryPercent)"
                    :style="'width: ' + gpuMemoryPercent + '%'"></div>
            </div>
            <div class="resource-detail">
                <span x-text="gpuName"></span>
                <span>VRAMï¼š<span x-text="gpuMemoryUsed"></span> / <span x-text="gpuMemoryTotal"></span> GB</span>
            </div>
        </div>

        <!-- ç£ç¢Ÿ -->
        <div class="resource-card">
            <div class="resource-header">
                <span class="resource-title">ğŸ’¾ ç£ç¢Ÿ</span>
                <span class="resource-value" x-text="diskPercent + '%'"></span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill" :class="getProgressClass(diskPercent)"
                    :style="'width: ' + diskPercent + '%'"></div>
            </div>
            <div class="resource-detail">
                <span>ä½¿ç”¨ï¼š<span x-text="diskUsed"></span> GB</span>
                <span>å¯ç”¨ï¼š<span x-text="diskFree"></span> GB</span>
            </div>
        </div>
    </div>

    <!-- çµ±è¨ˆè³‡è¨Š -->
    <div class="section-title">ç¿»è­¯çµ±è¨ˆï¼ˆ24 å°æ™‚ï¼‰</div>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" x-text="totalRequests"></div>
            <div class="stat-label">ç¸½è«‹æ±‚æ•¸</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" x-text="successRate + '%'"></div>
            <div class="stat-label">æˆåŠŸç‡</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" x-text="avgProcessingTime + ' ms'"></div>
            <div class="stat-label">å¹³å‡è™•ç†æ™‚é–“</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" x-text="activeConnections"></div>
            <div class="stat-label">ç›®å‰é€£ç·šæ•¸</div>
        </div>
    </div>

    <!-- ç³»çµ±è³‡è¨Š -->
    <div class="section-title">ç³»çµ±è³‡è¨Š</div>
    <div class="info-table">
        <div class="info-row">
            <span class="info-label">ä½œæ¥­ç³»çµ±</span>
            <span class="info-value" x-text="platform"></span>
        </div>
        <div class="info-row">
            <span class="info-label">ä¸»æ©Ÿåç¨±</span>
            <span class="info-value" x-text="hostname"></span>
        </div>
        <div class="info-row">
            <span class="info-label">Python ç‰ˆæœ¬</span>
            <span class="info-value" x-text="pythonVersion"></span>
        </div>
        <div class="info-row">
            <span class="info-label">åŸ·è¡Œæ¨¡å¼</span>
            <span class="info-value" x-text="executionMode"></span>
        </div>
        <div class="info-row">
            <span class="info-label">æœ€å¾Œæ›´æ–°</span>
            <span class="info-value" x-text="lastUpdate"></span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function adminStatusApp() {
        return {
            // ç‹€æ…‹
            loading: false,
            error: '',
            autoRefresh: false,
            refreshInterval: null,
            modelLoading: false,
            modelLoaded: false,
            modelLoadingComplete: false,
            modelLoadProgress: 0,
            modelLoadMessage: '',
            progressCheckInterval: null,

            // ç³»çµ±å¥åº·
            systemHealth: 'healthy',
            uptime: '-',
            modelStatus: '-',
            queueStatus: '-',

            // CPU
            cpuPercent: 0,
            cpuCores: 0,
            processCpu: 0,

            // è¨˜æ†¶é«”
            memoryPercent: 0,
            memoryUsed: 0,
            memoryTotal: 0,

            // GPU
            gpuAvailable: false,
            gpuName: '',
            gpuMemoryPercent: 0,
            gpuMemoryUsed: 0,
            gpuMemoryTotal: 0,

            // ç£ç¢Ÿ
            diskPercent: 0,
            diskUsed: 0,
            diskFree: 0,

            // çµ±è¨ˆ
            totalRequests: 0,
            successRate: 0,
            avgProcessingTime: 0,
            activeConnections: 0,

            // ç³»çµ±è³‡è¨Š
            platform: '-',
            hostname: '-',
            pythonVersion: '-',
            executionMode: '-',
            lastUpdate: '-',

            async init() {
                await this.refresh();
                this.checkModelLoadProgress();
            },

            async startModelLoading() {
                this.modelLoading = true;
                this.modelLoadProgress = 0;
                this.modelLoadMessage = 'æº–å‚™è¼‰å…¥...';

                try {
                    const response = await fetch('/api/v1/admin/model/load-progress/', {
                        method: 'POST',
                    });

                    if (response.ok) {
                        // é–‹å§‹å®šæœŸæª¢æŸ¥é€²åº¦
                        this.checkModelLoadProgressLoop();
                    } else {
                        this.error = 'ç„¡æ³•å•Ÿå‹•æ¨¡å‹è¼‰å…¥';
                        this.modelLoading = false;
                    }
                } catch (e) {
                    console.error('å•Ÿå‹•æ¨¡å‹è¼‰å…¥å¤±æ•—:', e);
                    this.error = 'ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨';
                    this.modelLoading = false;
                }
            },

            async checkModelLoadProgress() {
                try {
                    const response = await fetch('/api/v1/model/load-progress/');
                    if (response.ok) {
                        const data = await response.json();
                        this.modelLoaded = data.loaded;
                        this.modelLoadProgress = data.progress;

                        if (data.model_status === 'loading') {
                            this.modelLoading = true;
                            this.modelLoadMessage = 'æ¨¡å‹è¼‰å…¥ä¸­...';
                        } else if (data.loaded) {
                            this.modelLoading = false;
                            this.modelLoaded = true;
                            this.modelLoadProgress = 100;
                            this.modelLoadMessage = 'æ¨¡å‹å·²æˆåŠŸè¼‰å…¥ï¼';
                            this.modelLoadingComplete = true;
                        } else if (data.error_message) {
                            this.modelLoading = false;
                            this.modelLoadMessage = `éŒ¯èª¤: ${data.error_message}`;
                        }
                    }
                } catch (e) {
                    console.error('æª¢æŸ¥æ¨¡å‹é€²åº¦å¤±æ•—:', e);
                }
            },

            checkModelLoadProgressLoop() {
                // æ¯ 500ms æª¢æŸ¥ä¸€æ¬¡é€²åº¦
                this.progressCheckInterval = setInterval(() => {
                    this.checkModelLoadProgress();

                    // å¦‚æœæ¨¡å‹å·²è¼‰å…¥ï¼Œåœæ­¢æª¢æŸ¥
                    if (this.modelLoaded) {
                        clearInterval(this.progressCheckInterval);
                    }
                }, 500);
            },

            async refresh() {
                this.loading = true;
                this.error = '';

                try {
                    // å–å¾—ç³»çµ±ç‹€æ…‹
                    const statusResponse = await fetch('/api/v1/status/');
                    const statusData = await statusResponse.json();

                    if (statusResponse.ok) {
                        this.updateStatus(statusData);
                    } else {
                        this.error = statusData.error?.message || 'å–å¾—ç‹€æ…‹å¤±æ•—';
                    }

                    // å–å¾—çµ±è¨ˆè³‡è¨Š
                    const statsResponse = await fetch('/api/v1/statistics/');
                    const statsData = await statsResponse.json();

                    if (statsResponse.ok) {
                        this.updateStatistics(statsData);
                    }

                    // æª¢æŸ¥æ¨¡å‹ç‹€æ…‹
                    await this.checkModelLoadProgress();

                } catch (e) {
                    console.error('é‡æ–°æ•´ç†å¤±æ•—:', e);
                    this.error = 'ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨';
                } finally {
                    this.loading = false;
                }
            },

            updateStatus(data) {
                // åŸ·è¡Œæ™‚é–“
                this.uptime = data.uptime?.app_uptime_formatted || '-';

                // æ¨¡å‹ç‹€æ…‹
                this.modelStatus = data.model?.loaded ? 'å·²è¼‰å…¥' : 'æœªè¼‰å…¥';
                this.executionMode = data.model?.execution_mode || '-';
                this.modelLoaded = data.model?.loaded || false;

                // ä½‡åˆ—ç‹€æ…‹
                const queue = data.queue || {};
                this.queueStatus = `è™•ç†ä¸­ ${queue.processing || 0} / ç­‰å¾… ${queue.waiting || 0}`;

                // CPU
                if (data.resources?.cpu?.available) {
                    this.cpuPercent = data.resources.cpu.percent || 0;
                    this.cpuCores = data.resources.cpu.count_logical || 0;
                    this.processCpu = data.resources.cpu.process_percent || 0;
                }

                // è¨˜æ†¶é«”
                if (data.resources?.memory?.available) {
                    this.memoryPercent = data.resources.memory.percent || 0;
                    this.memoryUsed = data.resources.memory.used_gb || 0;
                    this.memoryTotal = data.resources.memory.total_gb || 0;
                }

                // GPU
                if (data.resources?.gpu?.available && data.resources.gpu.devices?.length > 0) {
                    this.gpuAvailable = true;
                    const gpu = data.resources.gpu.devices[0];
                    this.gpuName = gpu.name || '';
                    this.gpuMemoryPercent = gpu.memory_percent || 0;
                    this.gpuMemoryUsed = gpu.allocated_memory_gb || 0;
                    this.gpuMemoryTotal = gpu.total_memory_gb || 0;
                } else {
                    this.gpuAvailable = false;
                }

                // ç£ç¢Ÿ
                if (data.resources?.disk?.available) {
                    this.diskPercent = data.resources.disk.percent || 0;
                    this.diskUsed = data.resources.disk.used_gb || 0;
                    this.diskFree = data.resources.disk.free_gb || 0;
                }

                // ç³»çµ±è³‡è¨Š
                if (data.system) {
                    this.platform = `${data.system.platform} ${data.system.platform_release}`;
                    this.hostname = data.system.hostname || '-';
                    this.pythonVersion = data.system.python_version || '-';
                }

                // åˆ¤æ–·å¥åº·ç‹€æ…‹
                this.updateHealthStatus();

                // æ›´æ–°æ™‚é–“
                this.lastUpdate = new Date().toLocaleTimeString('zh-TW');
            },

            updateStatistics(data) {
                const stats = data.statistics || {};
                this.totalRequests = stats.total_requests || 0;
                this.successRate = stats.success_rate || 0;
                this.avgProcessingTime = Math.round(stats.avg_processing_time_ms || 0);
                this.activeConnections = stats.active_connections || 0;
            },

            updateHealthStatus() {
                if (this.cpuPercent > 90 || this.memoryPercent > 90) {
                    this.systemHealth = 'error';
                } else if (this.cpuPercent > 70 || this.memoryPercent > 70) {
                    this.systemHealth = 'warning';
                } else {
                    this.systemHealth = 'healthy';
                }
            },

            toggleAutoRefresh() {
                if (this.autoRefresh) {
                    this.refreshInterval = setInterval(() => this.refresh(), 30000);
                } else {
                    if (this.refreshInterval) {
                        clearInterval(this.refreshInterval);
                        this.refreshInterval = null;
                    }
                }
            },

            getHealthClass() {
                return {
                    'status-healthy': this.systemHealth === 'healthy',
                    'status-warning': this.systemHealth === 'warning',
                    'status-error': this.systemHealth === 'error',
                };
            },

            getHealthText() {
                const texts = {
                    healthy: 'æ­£å¸¸é‹ä½œ',
                    warning: 'éœ€è¦æ³¨æ„',
                    error: 'ç•°å¸¸',
                };
                return texts[this.systemHealth] || '-';
            },

            getProgressClass(percent) {
                if (percent > 90) return 'progress-danger';
                if (percent > 70) return 'progress-warning';
                return 'progress-normal';
            },
        };
    }
</script>
{% endblock %}
