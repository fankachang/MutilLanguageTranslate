{% extends 'translator/base.html' %}
{% load static %}

{% block title %}ç¿»è­¯ - å¤šåœ‹èªè¨€ç¿»è­¯ç³»çµ±{% endblock %}

{% block content %}
<div x-data="translationApp()" x-init="init()">
    <!-- ç¿»è­¯å€å¡Š -->
    <div class="translation-container">
        <!-- ä¾†æºæ–‡å­—å€å¡Š -->
        <div class="translation-panel">
            <div class="panel-header">
                <div class="language-selector">
                    <label for="source-lang" class="form-label">ä¾†æºèªè¨€</label>
                    <select id="source-lang" class="form-select" x-model="sourceLang"
                        style="width: auto; min-width: 150px;">
                        <option value="auto">è‡ªå‹•åµæ¸¬</option>
                        {% for lang in languages %}
                        <option value="{{ lang.code }}">{{ lang.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <span class="char-count" :class="{ 'warning': charCount > 8000, 'error': charCount > 10000 }">
                    <span x-text="charCount"></span> / 10,000 å­—å…ƒ
                </span>
            </div>

            <textarea id="source-text" class="form-control" placeholder="è«‹è¼¸å…¥è¦ç¿»è­¯çš„æ–‡å­—..." x-model="sourceText"
                @input="updateCharCount"
                style="min-height: 200px; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px;"></textarea>

            <!-- åµæ¸¬åˆ°çš„èªè¨€ -->
            <div x-show="detectedLanguage" class="detected-language" style="margin-top: 8px;">
                <span>åµæ¸¬åˆ°ï¼š</span>
                <strong x-text="getLanguageName(detectedLanguage)"></strong>
                <span x-show="confidenceScore" class="text-secondary">
                    (<span x-text="Math.round(confidenceScore * 100)"></span>% ä¿¡å¿ƒåº¦)
                </span>
            </div>
        </div>

        <!-- ç›®æ¨™æ–‡å­—å€å¡Š -->
        <div class="translation-panel">
            <div class="panel-header">
                <div class="language-selector">
                    <label for="target-lang" class="form-label">ç›®æ¨™èªè¨€</label>
                    <select id="target-lang" class="form-select" x-model="targetLang"
                        style="width: auto; min-width: 150px;">
                        {% for lang in languages %}
                        <option value="{{ lang.code }}">{{ lang.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="button" class="btn btn-secondary" @click="copyResult" :disabled="!translatedText"
                    x-show="translatedText" style="padding: 6px 12px; font-size: 0.875rem;">
                    ğŸ“‹ è¤‡è£½
                </button>
            </div>

            <div class="result-container" style="position: relative;">
                <div class="result-text" style="min-height: 200px; color: var(--text-primary); vertical-align: top;">
                    <span x-show="!translatedText && !isLoading" style="color: #6c757d; opacity: 1;"> </span>
                    <span x-show="translatedText" x-text="translatedText"
                        style="white-space: pre-wrap; color: var(--text-primary);"></span>
                </div>

                <!-- è¼‰å…¥ä¸­è¦†è“‹å±¤ -->
                <div x-show="isLoading" class="loading-overlay"
                    style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background-color: rgba(255,255,255,0.8); border-radius: 6px;">
                    <div class="loading-text">
                        <span class="spinner"></span>
                        <span>ç¿»è­¯ä¸­...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å‹•ä½œæŒ‰éˆ•å€ -->
    <div class="action-buttons">
        <!-- æ¨¡å‹é¸æ“‡ï¼ˆUS1ï¼‰ -->
        <div class="model-selector" style="display: flex; align-items: center; gap: 8px;">
            <label for="model-select" class="form-label" style="margin: 0; white-space: nowrap;">æ¨¡å‹</label>
            <select id="model-select" class="form-select" x-model="selectedModelId" @change="onModelSelected"
                style="width: auto; min-width: 220px;">
                <option value="">ï¼ˆé è¨­ï¼‰</option>
                <template x-for="m in models" :key="m.model_id">
                    <option :value="m.model_id" x-text="m.display_name"></option>
                </template>
            </select>
            <span x-show="isSwitchingModel" class="text-secondary" style="font-size: 0.875rem;">åˆ‡æ›ä¸­...</span>
            <span x-show="!hasAvailableModels" style="font-size: 0.875rem; color: var(--error-color);">æœªåµæ¸¬åˆ°å¯ç”¨æ¨¡å‹</span>
        </div>

        <button type="button" class="swap-button" @click="swapLanguages" title="äº¤æ›èªè¨€" :disabled="sourceLang === 'auto'">
            â‡„
        </button>

        <button type="button" class="btn btn-primary" @click="translate"
            :disabled="isLoading || isSwitchingModel || !hasAvailableModels || !sourceText.trim()">
            <span x-show="!isLoading">ğŸŒ ç¿»è­¯</span>
            <span x-show="isLoading">
                <span class="spinner" style="width: 16px; height: 16px; margin-right: 8px;"></span>
                è™•ç†ä¸­...
            </span>
        </button>

        <button type="button" class="btn btn-secondary" @click="clearAll" :disabled="isLoading">
            ğŸ—‘ï¸ æ¸…é™¤
        </button>
    </div>

    <!-- éŒ¯èª¤è¨Šæ¯ -->
    <div x-show="errorMessage" x-transition class="error-message"
        style="background-color: var(--error-color); color: white; padding: 12px 16px; border-radius: 6px; margin-top: 16px;">
        <strong>éŒ¯èª¤ï¼š</strong>
        <span x-text="errorMessage"></span>
        <button type="button" @click="errorMessage = ''"
            style="float: right; background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem;">&times;</button>
    </div>

    <!-- æˆåŠŸæç¤º -->
    <div x-show="successMessage" x-transition class="success-message"
        style="background-color: var(--success-color); color: white; padding: 12px 16px; border-radius: 6px; margin-top: 16px;">
        <span x-text="successMessage"></span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function translationApp() {
        return {
            // ç‹€æ…‹
            sourceText: '',
            translatedText: '',
            sourceLang: 'auto',
            targetLang: '{{ default_target_lang }}',
            charCount: 0,
            isLoading: false,
            isSwitchingModel: false,
            errorMessage: '',
            successMessage: '',
            detectedLanguage: null,
            confidenceScore: null,

            // æ¨¡å‹
            models: [],
            selectedModelId: '',
            activeModelId: null,
            hasAvailableModels: true,

            // èªè¨€åç¨±å°ç…§
            languageNames: {
                'zh-TW': 'ç¹é«”ä¸­æ–‡',
                'zh-CN': 'ç°¡é«”ä¸­æ–‡',
                'en': 'è‹±æ–‡',
                'ja': 'æ—¥æ–‡',
                'ko': 'éŸ“æ–‡',
                'fr': 'æ³•æ–‡',
                'de': 'å¾·æ–‡',
                'es': 'è¥¿ç­ç‰™æ–‡',
                'auto': 'è‡ªå‹•åµæ¸¬',
            },

            // åˆå§‹åŒ–
            init() {
                // å¾ sessionStorage è®€å–è¨­å®š
                const settings = JSON.parse(sessionStorage.getItem('userSettings') || '{}');
                if (settings.defaultSourceLang) {
                    this.sourceLang = settings.defaultSourceLang;
                }
                if (settings.defaultTargetLang) {
                    this.targetLang = settings.defaultTargetLang;
                }

                // æ¨¡å‹é¸æ“‡ï¼ˆsessionStorageï¼‰
                this.selectedModelId = sessionStorage.getItem('selectedModelId') || '';

                // è¼‰å…¥æ¨¡å‹æ¸…å–®
                this.loadModels();
            },

            async loadModels() {
                try {
                    const response = await fetch('/api/v1/models/', { method: 'GET' });
                    if (!response.ok) {
                        this.models = [];
                        this.activeModelId = null;
                        this.hasAvailableModels = false;
                        this.errorMessage = 'ç„¡æ³•å–å¾—å¯ç”¨æ¨¡å‹æ¸…å–®ï¼Œè«‹ç¨å¾Œå†è©¦';
                        return;
                    }

                    const data = await response.json();
                    this.models = data.models || [];
                    this.activeModelId = data.active_model_id || null;
                    this.hasAvailableModels = this.models.length > 0;

                    if (!this.hasAvailableModels) {
                        this.errorMessage = 'æœªåµæ¸¬åˆ°å¯ç”¨æ¨¡å‹ï¼Œè«‹ç¢ºèª models/<model_id>/config.json æ˜¯å¦å­˜åœ¨';
                    }

                    // è‹¥ç›®å‰é¸æ“‡ä¸åœ¨æ¸…å–®ä¸­ï¼Œå›é€€ç‚ºé è¨­
                    const availableIds = new Set(this.models.map(m => m.model_id));
                    if (this.selectedModelId && !availableIds.has(this.selectedModelId)) {
                        this.selectedModelId = '';
                        sessionStorage.removeItem('selectedModelId');
                    }
                } catch (e) {
                    console.warn('è¼‰å…¥æ¨¡å‹æ¸…å–®å¤±æ•—:', e);
                    this.models = [];
                    this.activeModelId = null;
                    this.hasAvailableModels = false;
                    this.errorMessage = 'è¼‰å…¥æ¨¡å‹æ¸…å–®å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦';
                }
            },

            async onModelSelected() {
                sessionStorage.setItem('selectedModelId', this.selectedModelId || '');

                this.errorMessage = '';
                this.successMessage = '';

                // åŒæ­¥åˆ° server sessionï¼ˆå¯é¸ï¼‰
                if (!this.selectedModelId) {
                    return;
                }

                try {
                    const selectionRes = await fetch('/api/v1/models/selection/', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model_id: this.selectedModelId }),
                    });

                    const selectionData = await selectionRes.json();
                    if (!selectionRes.ok) {
                        this.errorMessage = selectionData?.error?.message || 'æ¨¡å‹é¸æ“‡å¤±æ•—';
                        return;
                    }

                    // éœ€è¦åˆ‡æ›å°±è§¸ç™¼ switchï¼ˆæœ€å°æµç¨‹ï¼›å¾ŒçºŒä»»å‹™æœƒè£œé½Šæ›´å®Œæ•´çš„ç‹€æ…‹ç®¡ç†ï¼‰
                    if (selectionData.requires_switch) {
                        this.isSwitchingModel = true;
                        const switchRes = await fetch('/api/v1/models/switch/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ model_id: this.selectedModelId, force: false }),
                        });
                        const switchData = await switchRes.json();
                        if (!switchRes.ok) {
                            this.errorMessage = switchData?.error?.message || 'æ¨¡å‹åˆ‡æ›å¤±æ•—';
                        } else {
                            this.activeModelId = switchData.active_model_id;
                        }
                    }
                } catch (e) {
                    console.error('æ¨¡å‹åˆ‡æ›éŒ¯èª¤:', e);
                    this.errorMessage = 'æ¨¡å‹åˆ‡æ›å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
                } finally {
                    this.isSwitchingModel = false;
                }
            },

            // æ›´æ–°å­—æ•¸
            updateCharCount() {
                this.charCount = this.sourceText.length;
            },

            // å–å¾—èªè¨€åç¨±
            getLanguageName(code) {
                return this.languageNames[code] || code;
            },

            // äº¤æ›èªè¨€
            swapLanguages() {
                if (this.sourceLang === 'auto') return;

                const temp = this.sourceLang;
                this.sourceLang = this.targetLang;
                this.targetLang = temp;

                // ä¹Ÿäº¤æ›æ–‡å­—
                if (this.translatedText) {
                    const tempText = this.sourceText;
                    this.sourceText = this.translatedText;
                    this.translatedText = tempText;
                    this.updateCharCount();
                }
            },

            // åŸ·è¡Œç¿»è­¯
            async translate() {
                if (!this.hasAvailableModels) {
                    this.errorMessage = 'ç›®å‰æ²’æœ‰å¯ç”¨æ¨¡å‹ï¼Œè«‹å…ˆæ”¾å…¥ models/<model_id>/config.json å¾Œå†è©¦';
                    return;
                }

                if (!this.sourceText.trim()) {
                    this.errorMessage = 'è«‹è¼¸å…¥è¦ç¿»è­¯çš„æ–‡å­—';
                    return;
                }

                if (this.charCount > 10000) {
                    this.errorMessage = 'æ–‡å­—é•·åº¦è¶…é 10,000 å­—å…ƒï¼Œè«‹ç¸®çŸ­å¾Œå†è©¦';
                    return;
                }

                this.isLoading = true;
                this.errorMessage = '';
                this.successMessage = '';
                this.detectedLanguage = null;
                this.confidenceScore = null;

                try {
                    const payload = {
                        text: this.sourceText,
                        source_language: this.sourceLang,
                        target_language: this.targetLang,
                        quality: sessionStorage.getItem('quality') || 'standard',
                    };
                    if (this.selectedModelId) {
                        payload.model_id = this.selectedModelId;
                    }

                    const response = await fetch('/api/v1/translate/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                    });

                    const data = await response.json();

                    if (response.ok && data.status === 'completed') {
                        this.translatedText = data.translated_text;

                        if (data.detected_language) {
                            this.detectedLanguage = data.detected_language;
                            this.confidenceScore = data.confidence_score;
                        }

                        // å„²å­˜åˆ°æ­·å²è¨˜éŒ„
                        this.saveToHistory(data);

                    } else if (data.status === 'queued') {
                        this.errorMessage = `ç³»çµ±ç¹å¿™ï¼Œæ‚¨çš„è«‹æ±‚åœ¨ç¬¬ ${data.queue_position} ä½ï¼Œè«‹ç¨å€™...`;
                        // å¯ä»¥åœ¨é€™è£¡å¯¦ä½œè¼ªè©¢

                    } else if (data.error) {
                        this.errorMessage = data.error.message || 'ç¿»è­¯å¤±æ•—';

                    } else {
                        this.errorMessage = 'ç¿»è­¯å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
                    }

                } catch (error) {
                    console.error('ç¿»è­¯éŒ¯èª¤:', error);
                    this.errorMessage = 'ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹';
                } finally {
                    this.isLoading = false;
                }
            },

            // è¤‡è£½çµæœ
            async copyResult() {
                if (!this.translatedText) return;

                try {
                    await navigator.clipboard.writeText(this.translatedText);
                    this.successMessage = 'å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼';
                    setTimeout(() => {
                        this.successMessage = '';
                    }, 2000);
                } catch (error) {
                    this.errorMessage = 'è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½';
                }
            },

            // æ¸…é™¤å…¨éƒ¨
            clearAll() {
                this.sourceText = '';
                this.translatedText = '';
                this.charCount = 0;
                this.errorMessage = '';
                this.successMessage = '';
                this.detectedLanguage = null;
                this.confidenceScore = null;
            },

            // å„²å­˜åˆ°æ­·å²è¨˜éŒ„
            saveToHistory(data) {
                try {
                    let history = JSON.parse(sessionStorage.getItem('translationHistory') || '[]');

                    const item = {
                        id: data.request_id,
                        originalText: this.sourceText.substring(0, 50) + (this.sourceText.length > 50 ? '...' : ''),
                        translatedText: data.translated_text.substring(0, 50) + (data.translated_text.length > 50 ? '...' : ''),
                        fullOriginalText: this.sourceText,
                        fullTranslatedText: data.translated_text,
                        sourceLang: this.sourceLang,
                        targetLang: this.targetLang,
                        detectedLang: data.detected_language || null,
                        timestamp: new Date().toISOString(),
                    };

                    // åŠ åˆ°é–‹é ­
                    history.unshift(item);

                    // æœ€å¤šä¿ç•™ 20 ç­†
                    if (history.length > 20) {
                        history = history.slice(0, 20);
                    }

                    sessionStorage.setItem('translationHistory', JSON.stringify(history));
                } catch (error) {
                    console.error('å„²å­˜æ­·å²è¨˜éŒ„å¤±æ•—:', error);
                }
            },
        };
    }
</script>
{% endblock %}